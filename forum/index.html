<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trouvix</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#009B3A',
                            600: '#008030',
                        },
                        secondary: {
                            500: '#FBDE4A',
                            600: '#F0D030',
                        },
                        accent: {
                            500: '#DC241F',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .hero-pattern {
            background-image: radial-gradient(circle, rgba(0, 155, 58, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .offline-badge {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.7;
            }
        }

        .cat-card {
            background: #fff;
            border-radius: 1rem;
            border: 2px solid #e5e7eb;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
            min-height: 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px 0 #0001;
            cursor: pointer;
        }

        .cat-card .font-bold {
            font-size: 1.1em;
            font-family: 'Orbitron', 'Segoe UI', Arial, sans-serif;
            letter-spacing: 0.03em;
            text-shadow: none;
        }

        .cat-general {
            border-color: #009B3A;
        }

        .cat-annonces {
            border-color: #FBDE4A;
        }

        .cat-entraide {
            border-color: #4F46E5;
        }

        .cat-divers {
            border-color: #DC241F;
        }

        .cat-general .font-bold {
            color: #009B3A;
        }

        .cat-annonces .font-bold {
            color: #B89B0A;
        }

        .cat-entraide .font-bold {
            color: #4F46E5;
        }

        .cat-divers .font-bold {
            color: #DC241F;
        }

        .cat-card:hover {
            border-color: #009B3A;
            box-shadow: 0 4px 16px 0 #009b3a22;
            transform: translateY(-2px) scale(1.03);
        }
    </style>
</head>

<body class="font-sans"
    style="background:linear-gradient(135deg,#009B3A 0%,#FBDE4A 50%,#DC241F 100%);min-height:100vh;">
    <audio id="congo-anthem" src="congoanthem.mp3" autoplay loop muted></audio>
    <button id="anthem-play-btn"
        style="position:fixed;bottom:18px;right:18px;z-index:9999;display:none;background:#009B3A;color:#fff;border:none;border-radius:50%;width:48px;height:48px;box-shadow:0 2px 8px #0003;align-items:center;justify-content:center;font-size:1.5em;cursor:pointer;"
        title="Activer le son du site">&#9835;</button>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const anthem = document.getElementById('congo-anthem');
            const anthemBtn = document.getElementById('anthem-play-btn');
            if (anthem) {
                anthem.volume = 0.25;
                anthem.muted = false;
                function hideAnthemBtn() {
                    anthemBtn.style.display = 'none';
                }
                function showAnthemBtn() {
                    anthemBtn.style.display = 'flex';
                    anthemBtn.disabled = false;
                    anthemBtn.style.pointerEvents = 'auto';
                    anthemBtn.focus();
                }
                function tryPlayAnthem() {
                    anthem.muted = false;
                    anthem.play().then(hideAnthemBtn).catch(showAnthemBtn);
                }
                tryPlayAnthem();
                anthemBtn.addEventListener('click', function(e) {
                    console.log('Bouton son cliqu√©');
                    anthem.muted = false;
                    anthem.play().then(hideAnthemBtn).catch(showAnthemBtn);
                });
                // D√©clencheur universel sur premi√®re interaction utilisateur
                let anthemTried = false;
                function userTryPlayAnthem() {
                    if (!anthemTried) {
                        anthem.muted = false;
                        anthem.play().then(hideAnthemBtn).catch(showAnthemBtn);
                        anthemTried = true;
                        window.removeEventListener('click', userTryPlayAnthem);
                        window.removeEventListener('touchstart', userTryPlayAnthem);
                    }
                }
                window.addEventListener('click', userTryPlayAnthem);
                window.addEventListener('touchstart', userTryPlayAnthem);
            }
        });
    </script>
    <div id="publish-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden"
        style="background:rgba(0,0,0,0.45);" data-cy="forum-publish-modal">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center animate-fadeIn relative">
            <div class="flex justify-center mb-3">
                <svg width="48" height="48" fill="none" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="12" fill="#009B3A" />
                    <path d="M9 12l2 2 4-4" stroke="#fff" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-primary-600">Sujet soumis !</h2>
            <p class="text-gray-700 mb-6">Votre sujet a √©t√© soumis et sera visible apr√®s validation par un
                administrateur.</p>
            <button id="close-publish-modal"
                class="bg-primary-500 hover:bg-primary-600 text-white px-6 py-2 rounded-lg font-semibold shadow transition" data-cy="forum-publish-close">Fermer</button>
        </div>
    </div>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.25s;
        }
    </style>
    <nav class="bg-primary-500 text-white shadow-lg" data-cy="forum-nav">
        <div class="w-full" style="background: linear-gradient(90deg, #009B3A 0%, #FBDE4A 50%, #DC241F 100%);">
            <div class="container mx-auto px-4 py-5 flex flex-col items-center justify-center relative">
                <div class="flex flex-row items-center w-full justify-start pl-2 pr-10 relative"
                    style="min-height:3.5rem;">

                    <span
                        class="font-extrabold text-lg sm:text-xl md:text-2xl tracking-wide whitespace-nowrap overflow-hidden text-ellipsis"
                        style="color:#fff;font-family:'Orbitron','Segoe UI',Arial,sans-serif;letter-spacing:0.08em;max-width:60vw;text-align:left;line-height:1.2;" data-cy="forum-title">R√©p.
                        du Congo</span>
                    <button id="burger-btn"
                        class="absolute right-2 top-1 flex flex-col justify-center items-center w-10 h-10 rounded focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white shadow md:hidden"
                        aria-label="Ouvrir le menu" data-cy="forum-burger-btn">
                        <span class="block w-6 h-0.5 bg-primary-500 mb-1 rounded transition"></span>
                        <span class="block w-6 h-0.5 bg-primary-500 mb-1 rounded transition"></span>
                        <span class="block w-6 h-0.5 bg-primary-500 rounded transition"></span>
                    </button>
                </div>
                <div class="flex flex-col items-start w-full pl-2 mt-1">
                    <span class="font-extrabold text-base md:text-lg text-left"
                        style="color:#fff;font-family:'Orbitron','Segoe UI',Arial,sans-serif;letter-spacing:0.08em;max-width:90vw;line-height:1.2;">Unit√©
                        - Travail - Progr√®s</span>
                    <span
                        style="display:block;width:120px;height:5px;border-radius:4px;margin-top:1.1rem;background:linear-gradient(90deg,#009B3A 0 33%,#FBDE4A 33% 66%,#DC241F 66% 100%);"></span>
                </div>
            </div>
            <div class="container mx-auto px-4 flex justify-center md:justify-between items-center pb-2">
                <div class="hidden md:flex space-x-8 ml-auto" id="main-menu">
                    <a href="../index.html" class="hover:text-secondary-500 font-extrabold text-white transition"
                        style="font-family:'Orbitron','Segoe UI',Arial,sans-serif;letter-spacing:0.08em;line-height:1.2;" data-cy="forum-nav-accueil">Accueil</a>
                    <a href="#categories" class="hover:text-secondary-500 font-extrabold text-white transition"
                        style="font-family:'Orbitron','Segoe UI',Arial,sans-serif;letter-spacing:0.08em;line-height:1.2;" data-cy="forum-nav-categories">Cat√©gories</a>
                    <a href="#recents" class="hover:text-secondary-500 font-extrabold text-white transition"
                        style="font-family:'Orbitron','Segoe UI',Arial,sans-serif;letter-spacing:0.08em;line-height:1.2;" data-cy="forum-nav-recents">Sujets
                        r√©cents</a>
                </div>
                <div id="mobile-menu"
                    class="md:hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-40 z-50 hidden">
                    <div class="bg-white w-64 h-full shadow-lg p-6 flex flex-col absolute right-0 top-0">
                        <button id="close-mobile-menu" class="self-end mb-6 text-gray-400 hover:text-gray-700"><i
                                data-feather="x"></i></button>
                        <a href="../index.html"
                            class="mb-4 text-lg font-medium text-primary-500 hover:text-secondary-500 transition">Accueil</a>
                        <a href="#categories"
                            class="mb-4 text-lg font-medium text-primary-500 hover:text-secondary-500 transition">Cat√©gories</a>
                        <a href="#recents"
                            class="mb-4 text-lg font-medium text-primary-500 hover:text-secondary-500 transition">Sujets
                            r√©cents</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="hero-pattern bg-primary-50 py-12">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-primary-600 mb-4">Forum</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-8">
                Posez vos questions, partagez vos id√©es et exp√©riences.
            </p>
            <button id="new-topic-btn"
                class="bg-primary-500 hover:bg-primary-600 text-white font-medium py-3 px-6 rounded-lg shadow transition flex items-center justify-center mx-auto">
                <i data-feather="plus" class="mr-2"></i> Nouveau sujet
            </button>
        </div>
    </div>

    <main class="container mx-auto px-4 py-12">
        <section id="categories" class="mb-12">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i data-feather="grid" class="mr-2 text-primary-500"></i> Cat√©gories
            </h2>
            <div class="grid md:grid-cols-4 gap-6">
                <div class="cat-card cat-general bg-white p-4 rounded-xl shadow hover:shadow-lg transition cursor-pointer text-center"
                    onclick="filterCategory('general')">
                    <div class="text-primary-500 text-3xl mb-2"><i data-feather="message-circle"></i></div>
                    <div class="font-bold">G√©n√©ral</div>
                </div>
                <div class="cat-card cat-annonces bg-white p-4 rounded-xl shadow hover:shadow-lg transition cursor-pointer text-center"
                    onclick="filterCategory('annonces')">
                    <div class="text-primary-500 text-3xl mb-2"><i data-feather="alert-circle"></i></div>
                    <div class="font-bold">Annonces</div>
                </div>
                <div class="cat-card cat-entraide bg-white p-4 rounded-xl shadow hover:shadow-lg transition cursor-pointer text-center"
                    onclick="filterCategory('entraide')">
                    <div class="text-primary-500 text-3xl mb-2"><i data-feather="help-circle"></i></div>
                    <div class="font-bold">Entraide</div>
                </div>
                <div class="cat-card cat-divers bg-white p-4 rounded-xl shadow hover:shadow-lg transition cursor-pointer text-center"
                    onclick="filterCategory('divers')">
                    <div class="text-primary-500 text-3xl mb-2"><i data-feather="coffee"></i></div>
                    <div class="font-bold">Divers</div>
                </div>
            </div>
        </section>

        <section id="recents">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i data-feather="clock" class="mr-2 text-primary-500"></i> Sujets r√©cents
            </h2>
            <div id="topics-list" class="space-y-6">
            </div>
        </section>
    </main>

    <div id="topic-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 relative">
            <button id="close-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700">
                <i data-feather="x"></i>
            </button>
            <h2 class="text-xl font-bold mb-4 text-primary-600 flex items-center">
                <i data-feather="edit" class="mr-2"></i> Nouveau sujet
            </h2>
            <form id="topic-form">
                <input type="text" id="topic-title" class="w-full border border-gray-300 rounded-lg p-3 mb-4"
                    placeholder="Titre du sujet" required>
                <textarea id="topic-content" class="w-full border border-gray-300 rounded-lg p-3 mb-4" rows="4"
                    placeholder="Votre message..." required></textarea>
                <input type="text" id="topic-author" class="w-full border border-gray-300 rounded-lg p-3 mb-4" placeholder="Votre pseudo" readonly style="background:#f3f3f3;color:#888;">
                <input type="url" id="topic-video" class="w-full border border-gray-300 rounded-lg p-3 mb-4"
                    placeholder="Lien vid√©o (YouTube, Vimeo, etc. - optionnel)">
                <input type="file" id="topic-attachment" class="w-full border border-gray-300 rounded-lg p-3 mb-4"
                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.zip,.rar,.txt,.xls,.xlsx,.ppt,.pptx,.mp4,.avi,.mov,.mkv,.webm">
                <select id="topic-category" class="w-full border border-gray-300 rounded-lg p-3 mb-4" required>
                    <option value="general">G√©n√©ral</option>
                    <option value="annonces">Annonces</option>
                    <option value="entraide">Entraide</option>
                    <option value="divers">Divers</option>
                </select>
                <div class="flex justify-end">
                    <button type="submit"
                        class="bg-primary-500 hover:bg-primary-600 text-white px-5 py-2 rounded-lg font-medium transition">Publier</button>
                </div>
            </form>
        </div>
    </div>

    <div id="thread-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl p-6 relative">
            <button id="close-thread" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700">
                <i data-feather="x"></i>
            </button>
            <div id="thread-content">
            </div>
        </div>
    </div>

    <script>
        let topics = [];

        document.addEventListener('DOMContentLoaded', () => {
            reloadTopicsFromBackend();
        });

        let currentCategory = null;
        function renderTopics() {
            const list = document.getElementById('topics-list');
            list.innerHTML = '';
            let filtered = topics.filter(t => parseInt(t.validated) === 1);
            if (currentCategory) {
                filtered = filtered.filter(t => t.category === currentCategory);
            }
            if (filtered.length === 0) {
                list.innerHTML = '<div class="text-gray-500">Aucun sujet pour cette cat√©gorie.</div>';
                return;
            }
            const openReplyFormId = window._openReplyFormId;
            const replyDraft = window._replyDraft || {};
            filtered.slice().reverse().forEach(topic => {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-xl shadow-md p-6 mb-6 relative';
                const replyFormId = `reply-form-${topic.id}`;
                // --- Reaction system ---
                const reactions = JSON.parse(localStorage.getItem('forumReactions') || '{}');
                const topicReactions = reactions[topic.id] || [];
                const reactionTypes = [
                    { emoji: 'üëç', label: 'Like' },
                    { emoji: '‚ù§Ô∏è', label: 'Love' },
                    { emoji: 'üòÇ', label: 'Haha' },
                    { emoji: 'üéâ', label: 'Bravo' }
                ];
                let userName = window._forumUserName || 'Anonyme';
                div.innerHTML = `
                    <div class="flex items-center mb-2">
                        <span class="text-xs bg-primary-100 text-primary-500 px-2 py-1 rounded-full mr-2">${categoryLabel(topic.category)}</span>
                        <span class="text-xs text-gray-400">${topic.date}</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-1">${escapeHtml(topic.title)}</h3>
                    <div class="text-gray-600 mb-2">${escapeHtml(topic.content).slice(0, 120)}${topic.content.length > 120 ? '...' : ''}</div>
                    <div class="flex flex-wrap gap-2 mb-2">
                        ${reactionTypes.map(rt => {
                            const reacted = topicReactions.find(r => r.name === userName && r.type === rt.emoji);
                            return `<button class="reaction-btn px-2 py-1 rounded border ${reacted ? 'bg-primary-100 border-primary-500' : 'bg-gray-50 border-gray-300'}" data-topic="${topic.id}" data-type="${rt.emoji}" title="${rt.label}">${rt.emoji}</button>`;
                        }).join(' ')}
                    </div>
                    <div class="text-xs text-gray-500 mb-2">
                        ${topicReactions.length > 0 ?
                            topicReactions.map(r => `<span class="inline-block mr-2">${r.emoji}</span>`).join('')
                            : '<span>Aucune r√©action pour l\'instant.</span>'}
                    </div>
                    <div class="flex justify-between text-gray-500 text-sm mb-2">
                        <span><i data-feather="user" class="inline w-4 h-4 mr-1"></i> ${escapeHtml(topic.author || 'Anonyme')}</span>
                        <span class="reply-btn" data-topic-id="${topic.id}" style="cursor:pointer;"><i data-feather="message-square" class="inline w-4 h-4 mr-1"></i> 0 r√©ponse(s)</span>
                    </div>
                    <div id="${replyFormId}-container"></div>
                `;
                if (openReplyFormId && openReplyFormId == topic.id) {
                    const formContainer = div.querySelector(`#${replyFormId}-container`);
                    if (formContainer) {
                        // Pr√©remplir le champ auteur avec le nom de session
                        let defaultAuthor = window._forumUserName || 'Anonyme';
                        formContainer.innerHTML = `<form id="${replyFormId}" class="forum-reply-form mt-2 bg-gray-100 rounded p-3 flex flex-col gap-2" autocomplete="off">
                            <input type="text" name="author" placeholder="Votre nom" class="border rounded p-2 bg-gray-100 text-gray-500" value="${defaultAuthor}" readonly style="cursor:not-allowed;" />
                            <textarea name="content" placeholder="Votre r√©ponse..." class="border rounded p-2" required>${replyDraft.content || ''}</textarea>
                            <button type="submit" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-1 rounded">R√©pondre</button>
                        </form>`;
                        const form = document.getElementById(replyFormId);
                        // Focus et scroll doux sur le textarea
                        setTimeout(() => {
                            if (form && form.content) {
                                form.content.focus();
                                form.scrollIntoView({behavior:'smooth', block:'center'});
                            }
                        }, 50);
                        form.content.oninput = function () {
                            window._replyDraft = {
                                author: defaultAuthor,
                                content: form.content.value
                            };
                        };
                        form.onsubmit = function (ev) {
                            ev.preventDefault();
                            const author = defaultAuthor;
                            const content = form.content.value.trim();
                            if (!content) return;
                            fetch('../backend/add_reply.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    topic_id: topic.id,
                                    author,
                                    content
                                })
                            })
                                .then(r => r.json())
                                .then(res => {
                                    if (res.success) {
                                        // Laisser le formulaire ouvert, juste vider le champ r√©ponse
                                        form.content.value = '';
                                        window._replyDraft = { author: defaultAuthor, content: '' };
                                        reloadTopicsFromBackend();
                                    } else {
                                        alert(res.error || 'Erreur lors de l\'envoi de la r√©ponse');
                                    }
                                })
                                .catch(() => {
                                    alert('Erreur r√©seau');
                                });
                        };
                    }
                }
                setTimeout(() => {
                    // Reaction button event
                    div.querySelectorAll('.reaction-btn').forEach(btn => {
                        btn.onclick = function(e) {
                            e.stopPropagation();
                            const topicId = btn.getAttribute('data-topic');
                            const type = btn.getAttribute('data-type');
                            let reactions = JSON.parse(localStorage.getItem('forumReactions') || '{}');
                            let topicReactions = reactions[topicId] || [];
                            let userName = window._forumUserName || 'Anonyme';
                            // Supprimer toute r√©action pr√©c√©dente de cet utilisateur sur ce post
                            topicReactions = topicReactions.filter(r => r.name !== userName);
                            // Ajouter la nouvelle r√©action
                            topicReactions.push({ name: userName, type: type, emoji: type });
                            reactions[topicId] = topicReactions;
                            localStorage.setItem('forumReactions', JSON.stringify(reactions));
                            renderTopics();
                        };
                    });
                    // Reply button event
                    const replyBtn = div.querySelector('.reply-btn');
                    if (replyBtn) {
                        replyBtn.onclick = function (e) {
                            e.stopPropagation();
                            document.querySelectorAll('.forum-reply-form').forEach(f => f.remove());
                            window._openReplyFormId = topic.id;
                            const formContainer = div.querySelector(`#${replyFormId}-container`);
                            if (formContainer) {
                                formContainer.innerHTML = `<form id="${replyFormId}" class="forum-reply-form mt-2 bg-gray-100 rounded p-3 flex flex-col gap-2">
                                    <input type="text" name="author" placeholder="Votre nom (optionnel)" class="border rounded p-2" value="${window._replyDraft && window._replyDraft.author ? window._replyDraft.author : ''}" />
                                    <textarea name="content" placeholder="Votre r√©ponse..." class="border rounded p-2" required>${window._replyDraft && window._replyDraft.content ? window._replyDraft.content : ''}</textarea>
                                    <button type="submit" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-1 rounded">R√©pondre</button>
                                </form>`;
                                const form = document.getElementById(replyFormId);
                                form.author.oninput = form.content.oninput = function () {
                                    window._replyDraft = {
                                        author: form.author.value,
                                        content: form.content.value
                                    };
                                };
                                form.onsubmit = function (ev) {
                                    ev.preventDefault();
                                    const author = form.author.value.trim() || 'Anonyme';
                                    const content = form.content.value.trim();
                                    if (!content) return;
                                    fetch('../backend/add_reply.php', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            topic_id: topic.id,
                                            author,
                                            content
                                        })
                                    })
                                        .then(r => r.json())
                                        .then(res => {
                                            if (res.success) {
                                                window._openReplyFormId = null;
                                                window._replyDraft = {};
                                                reloadTopicsFromBackend();
                                                form.reset();
                                                form.remove();
                                            } else {
                                                alert(res.error || 'Erreur lors de l\'envoi de la r√©ponse');
                                            }
                                        })
                                        .catch(() => {
                                            alert('Erreur r√©seau');
                                        });
                                };
                            }
                        };
                    }
                }, 0);
                div.onclick = (e) => {
                    if (e.target.classList.contains('edit-topic-btn') || e.target.classList.contains('delete-topic-btn') || e.target.closest('.forum-reply-form')) return;
                    openThread(topic.id);
                };
                list.appendChild(div);
            });
            feather.replace();
        }

        function categoryLabel(cat) {
            switch (cat) {
                case 'general': return 'G√©n√©ral';
                case 'annonces': return 'Annonces';
                case 'entraide': return 'Entraide';
                case 'divers': return 'Divers';
                default: return cat;
            }
        }

        function escapeHtml(text) {
            return text.replace(/[&<>"]/g, function (c) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c];
            });
        }

        function filterCategory(cat) {
            currentCategory = cat;
            renderTopics();
        }

        document.getElementById('new-topic-btn').onclick = function () {
            document.getElementById('topic-modal').classList.remove('hidden');
            feather.replace();
        };
        document.getElementById('close-modal').onclick = function () {
            document.getElementById('topic-modal').classList.add('hidden');
        };
        // Pr√©remplit le pseudo avec le nom de session utilisateur (et le rend non modifiable)
        async function setForumPseudo() {
            try {
                const res = await fetch('../backend/get_user_info.php', { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    if (data && data.nom) {
                        const authorInput = document.getElementById('topic-author');
                        if (authorInput) {
                            authorInput.value = data.nom;
                        }
                        window._forumUserName = data.nom;
                    }
                }
            } catch(e) {
                window._forumUserName = 'Anonyme';
            }
        }
        document.addEventListener('DOMContentLoaded', setForumPseudo);

        document.getElementById('topic-form').onsubmit = function (e) {
            e.preventDefault();
            const title = document.getElementById('topic-title').value.trim();
            const content = document.getElementById('topic-content').value.trim();
            const author = document.getElementById('topic-author').value.trim() || 'Anonyme';
            const video = document.getElementById('topic-video').value.trim();
            const attachmentInput = document.getElementById('topic-attachment');
            let attachment = '';
            if (attachmentInput.files && attachmentInput.files.length > 0) {
                attachment = attachmentInput.files[0].name;
            }
            const category = document.getElementById('topic-category').value;
            if (!title || !content) return;
            fetch('../backend/add_topic.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title,
                    content,
                    author,
                    category,
                    video,
                    attachment
                })
            })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        document.getElementById('topic-modal').classList.add('hidden');
                        document.getElementById('topic-form').reset();
                        document.getElementById('publish-modal').classList.remove('hidden');
                        document.getElementById('close-publish-modal').onclick = function () {
                            document.getElementById('publish-modal').classList.add('hidden');
                        };
                        reloadTopicsFromBackend();
                    } else {
                        alert(res.error || 'Erreur lors de la publication');
                    }
                })
                .catch(() => {
                    alert('Erreur r√©seau');
                });
        };

        function reloadTopicsFromBackend() {
            fetch('../backend/get_topics.php')
                .then(r => r.json())
                .then(data => {
                    topics = Array.isArray(data) ? data : [];
                    renderTopics();
                });
        }

        setInterval(() => {
            reloadTopicsFromBackend();
        }, 5000);

        function openThread(id) {
            const topic = topics.find(t => t.id === id);
            if (!topic) return;
            const thread = document.getElementById('thread-content');
            thread.innerHTML = `
                <div class="mb-6">
                    <div class="flex items-center mb-2">
                        <span class="text-xs bg-primary-100 text-primary-500 px-2 py-1 rounded-full mr-2">${categoryLabel(topic.category)}</span>
                        <span class="text-xs text-gray-400">${topic.date}</span>
                        ${isAdmin ? `<span class='ml-auto flex gap-2'>
                            <button class='edit-topic-btn text-blue-600 hover:underline text-xs' data-id='${topic.id}'>√âditer</button>
                            <button class='delete-topic-btn text-red-600 hover:underline text-xs' data-id='${topic.id}'>Supprimer</button>
                        </span>` : ''}
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-1">${escapeHtml(topic.title)}</h3>
                    <div class="text-gray-600 mb-2">${escapeHtml(topic.content)}</div>
                    ${topic.video ? `<div class='mb-2'>
                        <strong class='text-primary-500'>Vid√©o :</strong><br>
                        <div class='aspect-w-16 aspect-h-9 mb-2'>
                            <iframe src='${embedVideo(topic.video)}' allowfullscreen class='w-full h-64 rounded-lg border'></iframe>
                        </div>
                    </div>` : ''}
                    ${topic.attachment ? `<div class='mb-2'>
                        <strong class='text-primary-500'>Pi√®ce jointe :</strong> <a href='${topic.attachment.url}' download='${topic.attachment.name}' class='text-blue-600 underline'>${topic.attachment.name}</a>
                    </div>` : ''}
                    <div class="flex justify-between text-gray-500 text-sm mb-2">
                        <span><i data-feather="user" class="inline w-4 h-4 mr-1"></i> ${escapeHtml(topic.author || 'Anonyme')}</span>
                        <span><i data-feather="message-square" class="inline w-4 h-4 mr-1"></i> ${topic.replies.length} r√©ponse(s)</span>
                    </div>
                </div>
                <div class="mb-4">
                    <h4 class="font-bold mb-2 text-primary-600">R√©ponses</h4>
                    <div id="replies-list">
                        ${topic.replies.length === 0 ? '<div class="text-gray-500">Aucune r√©ponse pour l\'instant.</div>' : ''}
                        ${topic.replies.map((r, idx) => `
                            <div class="bg-gray-100 rounded-lg p-3 mb-2 flex justify-between items-center">
                                <div>
                                    <div class="flex items-center mb-1">
                                        <span class="font-bold text-primary-500 mr-2">${escapeHtml(r.author || 'Anonyme')}</span>
                                        <span class="text-xs text-gray-400">${r.date}</span>
                                    </div>
                                    <div class="text-gray-700">${escapeHtml(r.content)}</div>
                                </div>
                                ${isAdmin ? `<div class='flex flex-col gap-1 ml-2'>
                                    <button class='edit-reply-btn text-blue-600 hover:underline text-xs' data-topic='${topic.id}' data-reply='${idx}'>√âditer</button>
                                    <button class='delete-reply-btn text-red-600 hover:underline text-xs' data-topic='${topic.id}' data-reply='${idx}'>Supprimer</button>
                                </div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <form id="reply-form">
                    <input type="text" id="reply-author" class="w-full border border-gray-300 rounded-lg p-2 mb-2"
                        placeholder="Votre pseudo (optionnel)">
                    <textarea id="reply-content" class="w-full border border-gray-300 rounded-lg p-2 mb-2" rows="2"
                        placeholder="Votre r√©ponse..." required></textarea>
                    <div class="flex justify-end">
                        <button type="submit"
                            class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-1 rounded-lg font-medium transition">R√©pondre</button>
                    </div>
                </form>
            `;
            document.getElementById('thread-modal').classList.remove('hidden');
            feather.replace();
            document.getElementById('reply-form').onsubmit = function (e) {
                e.preventDefault();
                const content = document.getElementById('reply-content').value.trim();
                const author = document.getElementById('reply-author').value.trim() || 'Anonyme';
                if (!content) return;
                topic.replies.push({
                    author,
                    content,
                    date: new Date().toISOString().slice(0, 16).replace('T', ' ')
                });
                openThread(id);
            };
        }
        document.getElementById('close-thread').onclick = function () {
            document.getElementById('thread-modal').classList.add('hidden');
        };

        function embedVideo(url) {
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let id = url.split('v=')[1] || '';
                if (url.includes('youtu.be/')) id = url.split('youtu.be/')[1];
                if (id.includes('&')) id = id.split('&')[0];
                return `https://www.youtube.com/embed/${id}`;
            }
            if (url.includes('vimeo.com')) {
                let id = url.split('vimeo.com/')[1];
                return `https://player.vimeo.com/video/${id}`;
            }
            if (url.match(/\.(mp4|webm)$/)) {
                return url;
            }
            return url;
        }

        function reloadTopics() {
            topics = JSON.parse(localStorage.getItem('forumTopics') || '[]');
            renderTopics();
            feather.replace();
        }
        reloadTopics();

        document.getElementById('burger-btn').onclick = function () {
            document.getElementById('mobile-menu').classList.remove('hidden');
        };
        document.getElementById('close-mobile-menu').onclick = function () {
            document.getElementById('mobile-menu').classList.add('hidden');
        };
        const burgerBtn = document.getElementById('burger-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMobileMenu = document.getElementById('close-mobile-menu');
        burgerBtn && burgerBtn.addEventListener('click', function () {
            mobileMenu.classList.remove('hidden');
            feather.replace();
        });
        closeMobileMenu && closeMobileMenu.addEventListener('click', function () {
            mobileMenu.classList.add('hidden');
        });
        mobileMenu && mobileMenu.addEventListener('click', function (e) {
            if (e.target === mobileMenu) {
                mobileMenu.classList.add('hidden');
            }
        });
    </script>
</body>

</html>