<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Créer un Salon - Trouvix</title>
	<style>
		body {
			background: radial-gradient(ellipse at 50% 0%, #1a1d3a 60%, #10132a 100%);
			color: #fff;
			font-family: 'Segoe UI', Arial, sans-serif;
			margin: 0;
			padding: 0;
			min-height: 100vh;

		.container {
			max-width: 370px;
			margin: 60px auto;
			background: rgba(24,28,58,0.98);
			padding: 38px 20px 32px 20px;
			border-radius: 1.7rem;
			box-shadow: 0 0 48px #00fff9cc, 0 0 0 3px #00fff933, 0 0 80px 8px #ff00ff22;
			border: 1.5px solid #00fff9;
			position: relative;
			overflow: hidden;
			animation: fadeIn 1.1s cubic-bezier(.4,0,.2,1);
		}
		@media (max-width: 600px) {
			.container {
				max-width: 98vw;
				margin: 24px auto;
				padding: 18px 4vw 24px 4vw;
				border-radius: 1.1rem;
			}
			h1 {
				font-size: 1.25em;
			}
			.form-input {
				font-size: 1em;
				padding: 0.7em 0.7em;
			}
			.avatar-upload-label {
				width: 64px;
				height: 64px;
			}
		}
		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(40px) scale(0.98); }
			to { opacity: 1; transform: none; }
		}
		h1 {
			color: #00fff9;
			font-size: 2.1em;
			margin-bottom: 1.3em;
			text-align: center;
			font-weight: bold;
			letter-spacing: 0.04em;
			text-shadow: 0 0 16px #00fff9, 0 0 32px #00fff9;
		}
		.form-group {
			margin-bottom: 1.7em;
			text-align: left;
			position: relative;
			display: flex;
			flex-direction: column;
			gap: 0.45em;
		}
		.form-label {
			color: #fff;
			font-weight: 600;
			margin-bottom: 0.1em;
			display: block;
			letter-spacing: 0.01em;
			text-shadow: 0 0 8px #00fff9cc;
			text-align: center;
			padding-left: 0;
		}
		.form-input {
			width: 85%;
			min-width: 160px;
			max-width: 260px;
			margin-left: auto;
			margin-right: auto;
			display: block;
			background: rgba(24,28,58,0.92);
			color: #00fff9;
			border: 2px solid #00fff9;
			border-radius: 0.7em;
			padding: 0.85em 1.1em 0.85em 1.1em;
			font-size: 1.13em;
			outline: none;
			margin-top: 0;
			margin-bottom: 0;
			transition: border 0.22s, box-shadow 0.22s;
			box-shadow: 0 0 0 0 #00fff9;
			font-weight: 500;
			line-height: 1.25;
		}
		.form-input:focus {
					border: 2.5px solid #ff00ff;
					box-shadow: 0 0 16px #ff00ff66, 0 0 24px #00fff9aa;
					background: #181c3a;
					color: #fff;
				}

				select.form-input {
					background: linear-gradient(90deg, #181c3a 60%, #00fff9 100%);
					color: #00fff9;
					font-weight: 600;
					border: 2px solid #00fff9;
					box-shadow: 0 0 8px #00fff966;
					transition: border 0.22s, box-shadow 0.22s, background 0.22s;
				}
				select.form-input:focus {
					border: 2.5px solid #ff00ff;
					box-shadow: 0 0 16px #ff00ff66, 0 0 32px #00fff9cc;
					background: linear-gradient(90deg, #181c3a 40%, #ff00ff 100%);
					color: #fff;
				}
				select.form-input option {
					background: #181c3a;
					color: #00fff9;
				}
				select.form-input option:checked {
					background: #ff00ff;
					color: #fff;
				}
		}
		.form-input:disabled {
			background: #222;
			color: #888;
			border: 2px dashed #888;
			font-style: italic;
			letter-spacing: 0.04em;
			opacity: 0.95;
		}
		.avatar-upload-label {
			width: 84px;
			height: 84px;
			border-radius: 50%;
			border: 3px solid #00fff9;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			overflow: hidden;
			position: relative;
			background: #222;
			box-shadow: 0 0 16px #00fff966, 0 0 32px #00fff933;
			margin: 0.2em auto 0.7em auto;
			transition: border 0.22s, box-shadow 0.22s;
		}
		.avatar-upload-label:hover, .avatar-upload-label:focus {
			border: 3px solid #ff00ff;
			box-shadow: 0 0 24px #ff00ff99, 0 0 48px #00fff966;
		}
		.avatar-placeholder {
			color: #00fff9;
			font-size: 2.5em;
			opacity: 0.7;
			transition: color 0.2s;
		}
		.avatar-upload-label:hover .avatar-placeholder {
			color: #ff00ff;
			opacity: 0.9;
		}
		.avatar-preview {
			display: none;
			width: 100%;
			height: 100%;
			object-fit: cover;
			border-radius: 50%;
			box-shadow: 0 0 16px #00fff966;
		}
		.btn-main {
			background: linear-gradient(90deg, #00fff9 0%, #00fff9 60%, #ff00ff 100%);
			color: #181c3a;
			border: none;
			border-radius: 0.9em;
			font-size: 1.22em;
			font-weight: bold;
			padding: 0.85em 2.2em;
			cursor: pointer;
			box-shadow: 0 0 24px #00fff966, 0 0 0 2px #00fff933;
			transition: background 0.22s, color 0.22s, box-shadow 0.22s, transform 0.13s;
			width: 100%;
			margin-top: 1.5em;
			letter-spacing: 0.04em;
			text-shadow: 0 0 8px #fff;
			position: relative;
			overflow: hidden;
		}
		.btn-main:hover, .btn-main:focus {
			background: linear-gradient(90deg, #ff00ff 0%, #00fff9 100%);
			color: #fff;
			box-shadow: 0 0 40px #ff00ffaa, 0 0 0 2px #00fff933;
			transform: scale(1.03);
		}
		.modal-bg {
			position: fixed;
			top: 0; left: 0; width: 100vw; height: 100vh;
			background: rgba(10,16,40,0.92);
			z-index: 1000;
			display: flex;
			align-items: center;
			justify-content: center;
			animation: fadeIn 0.7s cubic-bezier(.4,0,.2,1);
		}
		.modal-box {
			background: #181c3a;
			padding: 2.2em 2.5em 2em 2.5em;
			border-radius: 1.2em;
			box-shadow: 0 0 32px #00fff966,0 0 0 2px #00fff933, 0 0 80px 8px #ff00ff22;
			text-align: center;
			max-width: 90vw;
			border: 1.5px solid #00fff9;
			animation: fadeIn 0.7s cubic-bezier(.4,0,.2,1);
		}
		.modal-box img {
			width: 90px;
			height: 90px;
			border-radius: 50%;
			border: 3px solid #00fff9;
			margin-bottom: 0.7em;
			box-shadow: 0 0 24px #00fff966;
		}
		.modal-code {
			font-size: 1.35em;
			color: #ff00ff;
			font-weight: bold;
			margin: 0.7em 0 1.2em 0;
			letter-spacing: 0.12em;
			text-shadow: 0 0 12px #ff00ff99;
		}
		.btn-go {
			background: linear-gradient(90deg, #00fff9 0%, #ff00ff 100%);
			color: #181c3a;
			border: none;
			border-radius: 0.7em;
			font-size: 1.13em;
			font-weight: bold;
			padding: 0.7em 2.2em;
			cursor: pointer;
			box-shadow: 0 0 18px #00fff966;
			margin-top: 1.2em;
			transition: background 0.22s, color 0.22s, box-shadow 0.22s, transform 0.13s;
			letter-spacing: 0.04em;
		}
		.btn-go:hover, .btn-go:focus {
			background: linear-gradient(90deg, #ff00ff 0%, #00fff9 100%);
			color: #fff;
			box-shadow: 0 0 32px #ff00ffaa;
			transform: scale(1.04);
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>Créer un Salon</h1>
		<form id="creer-salon-form" autocomplete="off">
			<div class="form-group">
				<label class="form-label" for="nom-hote">Salon</label>
				<input class="form-input" id="nom-hote" maxlength="30" required type="text" placeholder="Nom du salon">
			</div>
			<div class="form-group">
				<label class="form-label" for="pseudo-hote">Hôte</label>
				<input class="form-input" id="pseudo-hote" maxlength="20" required type="text" placeholder="pseudo hôte" readonly>
			</div>
			<div class="form-group">
				<label class="form-label" for="nb-joueurs">Joueurs</label>
				<select class="form-input" id="nb-joueurs" required>
					<option value="" disabled selected>Choisir...</option>
					<option value="2">2 joueurs</option>
					<option value="3">3 joueurs</option>
					<option value="4">4 joueurs</option>
					<option value="5">5 joueurs</option>
				</select>
			</div>
			<div class="form-group">
				<label class="form-label" for="nb-mots">Nombre de mot à deviner</label>
				<select class="form-input" id="nb-mots" required>
					<option value="" disabled selected>Choisir...</option>
					<option value="6">6</option>
					<option value="7">7</option>
					<option value="8">8</option>
					<option value="9">9</option>
					<option value="10">10</option>
					<option value="11">11</option>
				</select>
			</div>
			<div class="form-group" style="text-align:center;">
				<label class="form-label">Photo</label>
				<label class="avatar-upload-label" tabindex="-1" style="cursor:default;">
					<img id="avatar-preview" class="avatar-preview" src="../assets/avatar-default.png" alt="Photo hôte" style="display:block;">
				</label>
			</div>
			<button type="submit" class="btn-main" id="btn-creer">Créer le Salon</button>
	</form>
	<button type="button" class="btn-main" style="margin-top:1.2em;background:linear-gradient(90deg,#444 60%,#00fff9 100%);color:#fff;" onclick="window.location.href='../index.html'">&#8592; Retour à l'accueil</button>
	</div>
	<script>
		function generateSalonCode() {
			const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
			let code = '';
			for (let i = 0; i < 4; i++) {
				code += chars.charAt(Math.floor(Math.random() * chars.length));
			}
			return 'VIX-' + code;
		}

		const avatarPreview = document.getElementById('avatar-preview');
		window.addEventListener('DOMContentLoaded', function () {
			fetch('../backend/get_user_info.php')
				.then(res => res.ok ? res.json() : null)
				.then(data => {
					if (data) {
						const pseudoInput = document.getElementById('pseudo-hote');
						if (data.nom && pseudoInput && !pseudoInput.value) {
							pseudoInput.value = data.nom;
						}
						if (data.photo && avatarPreview) {
							avatarPreview.src = data.photo;
							avatarPreview.style.display = 'block';
						} else if (avatarPreview) {
							avatarPreview.src = '../assets/avatar-default.png';
							avatarPreview.style.display = 'block';
						}
					}
				});
		});

		window.addEventListener('DOMContentLoaded', function () {
			fetch('../backend/get_user_info.php')
				.then(res => res.ok ? res.json() : null)
				.then(data => {
					if (data && data.nom) {
						const pseudoInput = document.getElementById('pseudo-hote');
						if (pseudoInput && !pseudoInput.value) {
							pseudoInput.value = data.nom;
						}
					}
				});
		});

		document.getElementById('creer-salon-form').addEventListener('submit', async function (e) {
			e.preventDefault();
			const nomSalon = document.getElementById('nom-hote').value.trim();
			const hote = document.getElementById('pseudo-hote').value.trim();
			const nbJoueurs = document.getElementById('nb-joueurs').value;
			const nbMots = document.getElementById('nb-mots').value;
			if (!nomSalon || !hote || !nbJoueurs || !nbMots) {
				alert("Tous les champs sont obligatoires.");
				return;
			}
			let photo = avatarPreview.src;
			if (!photo) photo = '../assets/avatar-default.png';
			const codeSalon = generateSalonCode();
			localStorage.setItem('trouvix_nbJoueurs', nbJoueurs);
			showSalonModal({
				nomSalon,
				hote,
				photo,
				code: codeSalon,
				nbJoueurs,
				nbMots
			});
		});

		function showSalonModal({ nomSalon, hote, photo, code, nbJoueurs, nbMots }) {
			let modal = document.getElementById('modal-salon-cree');
			if (modal) modal.remove();
			modal = document.createElement('div');
			modal.className = 'modal-bg';
			modal.id = 'modal-salon-cree';
			modal.innerHTML = `
				<div class="modal-box">
					<img src="${photo}" alt="Avatar Hôte">
					<div style="font-size:1.15em;color:#00fff9;font-weight:bold;margin-bottom:0.5em;">Salon créé avec succès !</div>
					<div style="margin-bottom:0.5em;">
						<b>Nom du salon :</b> ${nomSalon} <br>
						<b>Hôte :</b> ${hote} <br>
						<b>Joueurs :</b> ${nbJoueurs} <br>
						<b>Nombre de mots :</b> ${nbMots}
					</div>
					<div class="modal-code">${code}</div>
					<button class="btn-go" id="btn-go-salon">Go Salon</button>
				</div>
			`;
			document.body.appendChild(modal);
			const btnGoSalon = document.getElementById('btn-go-salon');
			if (btnGoSalon) {
				btnGoSalon.addEventListener('click', async function handleGoSalonClick(e) {
					btnGoSalon.disabled = true;
					let nomHote = hote;
					try {
						const userInfo = await fetch('../backend/get_user_info.php').then(r => r.ok ? r.json() : null);
						if (userInfo && userInfo.nom) {
							nomHote = userInfo.nom;
						}
					} catch (e) {}
					try {
						const response = await fetch('../backend/salons.php', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								nom: nomSalon,
								code: code,
								maxJoueurs: parseInt(nbJoueurs, 10),
								longueurMot: parseInt(nbMots, 10),
								createdAt: Math.floor(Date.now() / 1000),
								joueurs: [
									{
										nom: nomHote,
										photo: photo,
										estHote: true
									}
								]
							})
						});
						if (!response.ok) {
							alert("Erreur lors de la création du salon côté serveur.");
							btnGoSalon.disabled = false;
							return;
						}
					} catch (err) {
						alert("Erreur réseau lors de la création du salon.");
						btnGoSalon.disabled = false;
						return;
					}
					window.location.href = `salon.html?code=${code}`;
				}, { once: true });
			}
		}
	</script>
</body>
</html>
