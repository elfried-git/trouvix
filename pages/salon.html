<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salon en cours - DeviChal</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body {
      background: #10132a;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    .lobby-container {
      max-width: 700px;
      margin: 3.5rem auto;
      background: #181c3a;
      border-radius: 1.5rem;
      box-shadow: 0 0 32px #00fff966, 0 0 0 2px #00fff933;
      padding: 2.5rem 2rem 2.5rem 2rem;
      text-align: center;
      position: relative;
    }

    .lobby-title {
      font-size: 2rem;
      color: #00fff9;
      letter-spacing: 0.04em;
      text-shadow: 0 0 8px #00fff9, 0 0 24px #00fff9;
      margin-bottom: 1.2em;
    }

    .players-list {
      display: flex;
      justify-content: center;
      gap: 2.5em;
      margin-bottom: 2em;
      flex-wrap: wrap;
    }

    .player-slot {
      text-align: center;
      min-width: 90px;
    }

    .avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2.5px solid #00fff9;
      object-fit: cover;
      background: #222;
      margin: 0 auto 0.5em auto;
      box-shadow: 0 0 12px #00fff966;
    }

    .empty-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #222 url('../assets/avatar-default.png') center/60% no-repeat;
      border: 2.5px dashed #888;
      margin: 0 auto 0.5em auto;
      opacity: 0.5;
    }

    .player-name {
      color: #00fff9;
      font-size: 1em;
      margin-bottom: 0.2em;
      word-break: break-word;
    }

    .player-role {
      color: #ff00ff;
      font-size: 0.95em;
      font-weight: bold;
      margin-bottom: 0.2em;
    }

    .lobby-actions {
      display: flex;
      justify-content: center;
      gap: 1.5em;
      margin-top: 2em;
    }

    .btn-lobby {
      background: linear-gradient(90deg, #00fff9 60%, #ff00ff 100%);
      color: #181c3a;
      border: none;
      border-radius: 0.7em;
      font-size: 1.15em;
      font-weight: bold;
      padding: 0.7em 2.2em;
      cursor: pointer;
      box-shadow: 0 0 16px #00fff966;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      text-shadow: 0 0 8px #fff;
    }

    .btn-lobby:disabled {
      background: #222;
      color: #888;
      box-shadow: none;
      cursor: not-allowed;
    }

    @media (max-width: 600px) {
      .lobby-container {
        padding: 1.2rem 0.5rem;
      }

      .players-list {
        gap: 1em;
      }

      .player-slot {
        min-width: 70px;
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="header-row">
      <div class="logo" tabindex="0" aria-label="Accueil Trouvix">
        <span class="logo-text">Trouvix</span>
      </div>
    </div>
  </header>
  <div class="lobby-container">
    <div class="lobby-title" id="lobby-title">Salon</div>
    <div id="host-name" style="color:#ff00ff;font-size:1.1em;margin-bottom:1em;"></div>
    <div class="players-list" id="players-list"></div>
    <div class="lobby-actions">
      <button class="btn-lobby" id="btn-start" disabled>DÉMARRER</button>
      <button class="btn-lobby" id="btn-quit">QUITTER</button>
    </div>
    <div style="margin-top:2em;">
      <a href="../index.html" class="btn-lobby" style="text-decoration:none;display:inline-block;">&#8592; Retour à l'accueil</a>
    </div>
  </div>
  <script>
    // --- Paramètres du salon : récupération dynamique depuis le backend ---
    // On suppose que le code du salon est passé en query string (?code=XXXXXX)
    function getSalonCodeFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('code');
    }
    let salon = null;
    const minJoueurs = 2;

    async function chargerSalonEtAfficher() {
      const codeSalon = getSalonCodeFromURL();
      if (!codeSalon) {
        document.getElementById('lobby-title').textContent = 'Salon introuvable';
        document.getElementById('host-name').textContent = '';
        return;
      }
      // Récupérer la liste des salons depuis le backend
      let salons = [];
      try {
        const res = await fetch('../backend/salons.php');
        if (res.ok) salons = await res.json();
      } catch (e) { }
      salon = salons.find(s => s.code === codeSalon);
      if (!salon || !Array.isArray(salon.joueurs)) {
        document.getElementById('lobby-title').textContent = 'Salon introuvable';
        document.getElementById('host-name').textContent = '';
        return;
      }
      // Affichage dynamique du nom du salon
      document.getElementById('lobby-title').textContent = salon.nom && salon.nom.trim() ? salon.nom : 'Salon';
      // Affichage dynamique du nom et de la photo de l'hôte
      let host = salon.joueurs.find(j => j.estHote) || salon.joueurs[0];
      if (host) {
        document.getElementById('host-name').innerHTML = `<span style="color:#ff00ff;font-weight:bold;">Hôte :</span> <span style="color:#00fff9;">${host.nom}</span>`;
      }
      await renderPlayers();
      updateStartButton();
    }

    // --- Affichage des joueurs et places vides ---
    // --- Modale pour rejoindre une place ---
    function createJoinModal(onSubmit, onCancel) {
      let modal = document.getElementById('join-modal');
      if (modal) modal.remove();
      modal = document.createElement('div');
      modal.id = 'join-modal';
      modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,16,40,0.85);z-index:1000;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `
          <div style="background:#181c3a;padding:2em 2.5em 2em 2.5em;border-radius:1.2em;box-shadow:0 0 32px #00fff966,0 0 0 2px #00fff933;text-align:center;max-width:90vw;">
            <div style="font-size:1.5em;color:#00fff9;font-weight:bold;margin-bottom:1.2em;letter-spacing:0.02em;text-shadow:0 0 8px #00fff9,0 0 24px #00fff9;">Rejoindre le salon</div>
            <form id="join-form">
              <input type="text" id="join-nom" placeholder="Votre nom" maxlength="15" required style="margin-bottom:1.2em;width:92%;padding:0.7em 1.1em;font-size:1.15em;border-radius:0.7em;border:2px solid #00fff9;outline:none;box-shadow:0 0 8px #00fff966;background:#10132a;color:#00fff9;transition:border 0.2s;">
              <div style="display:flex;justify-content:center;align-items:center;margin-bottom:1.2em;">
                <label id="avatar-upload-label-modal" style="width:72px;height:72px;border-radius:50%;border:3px solid #00fff9;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative;background:#222;box-shadow:0 0 8px #00fff966;transition:border 0.2s;">
                  <input type="file" id="join-photo" accept="image/*" required style="display:none;">
                  <span id="avatar-placeholder-modal" style="color:#00fff9;font-size:2.2em;opacity:0.7;">+</span>
                  <img id="avatar-preview-modal" src="" alt="Aperçu photo" style="display:none;width:100%;height:100%;object-fit:cover;">
                </label>
              </div>
              <button type="submit" style="background:linear-gradient(90deg,#00fff9 60%,#ff00ff 100%);color:#181c3a;border:none;border-radius:0.7em;font-size:1.2em;font-weight:bold;padding:0.7em 2.5em;cursor:pointer;box-shadow:0 0 12px #00fff966;margin-right:1.2em;letter-spacing:0.02em;">Rejoindre</button>
              <button type="button" id="join-cancel" style="background:#222;color:#fff;border:none;border-radius:0.7em;font-size:1.2em;font-weight:bold;padding:0.7em 2.5em;cursor:pointer;box-shadow:0 0 8px #00fff966;letter-spacing:0.02em;">Annuler</button>
            </form>
          </div>
        `;
      document.body.appendChild(modal);
      // Pré-remplir le nom avec la session utilisateur et désactiver l'input
      fetch('../backend/get_user_info.php')
        .then(res => res.ok ? res.json() : null)
        .then(data => {
          if (data && data.nom) {
            const joinNomInput = document.getElementById('join-nom');
            joinNomInput.value = data.nom;
            joinNomInput.disabled = true;
          }
        });
      // Avatar preview logic
      const joinPhotoInput = document.getElementById('join-photo');
      const avatarPreview = document.getElementById('avatar-preview-modal');
      const avatarPlaceholder = document.getElementById('avatar-placeholder-modal');
      joinPhotoInput.onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (ev) {
            avatarPreview.src = ev.target.result;
            avatarPreview.style.display = 'block';
            avatarPlaceholder.style.display = 'none';
          };
          reader.readAsDataURL(file);
        } else {
          avatarPreview.src = '';
          avatarPreview.style.display = 'none';
          avatarPlaceholder.style.display = 'block';
        }
      };
      // Clic sur le rond déclenche le file input
      document.getElementById('avatar-upload-label-modal').onclick = function () {
        joinPhotoInput.click();
      };
      document.getElementById('join-form').onsubmit = function (e) {
        e.preventDefault();
        const nom = document.getElementById('join-nom').value.trim();
        const file = document.getElementById('join-photo').files[0];
        if (!nom || !file) return;
        const reader = new FileReader();
        reader.onload = function (ev) {
          onSubmit(nom, ev.target.result);
          modal.remove();
        };
        reader.readAsDataURL(file);
      };
      document.getElementById('join-cancel').onclick = function () {
        modal.remove();
        if (onCancel) onCancel();
      };
    }

    async function renderPlayers() {
      if (!salon || !Array.isArray(salon.joueurs)) return;
      const playersList = document.getElementById('players-list');
      playersList.innerHTML = '';
      // Récupérer l'utilisateur connecté
      let userNom = null;
      try {
        const res = await fetch('../backend/get_user_info.php');
        if (res.ok) {
          const data = await res.json();
          userNom = data.nom;
        }
      } catch (e) { }
      for (let i = 0; i < salon.maxJoueurs; i++) {
        let joueur = salon.joueurs[i];
        const slot = document.createElement('div');
        slot.className = 'player-slot';
        if (joueur) {
          // Si c'est l'hôte (toujours index 0), afficher l'intitulé Hôte sous la photo
          if (i === 0 && joueur.estHote) {
            slot.innerHTML = `
              <div style="display:flex;justify-content:center;align-items:center;">
                <img src="${joueur.photo || '../assets/avatar-default.png'}" class="avatar" alt="Avatar" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:2.5px solid #ff00ff;background:#222;box-shadow:0 0 12px #ff00ff66;" />
              </div>
              <div class="player-role" style="color:#ff00ff;font-weight:bold;font-size:1.15em;margin-top:0.3em;">Hôte</div>
              <div class="player-name" style="color:#00fff9;">${joueur.nom}</div>
            `;
          } else {
            slot.innerHTML = `
              <div style="display:flex;justify-content:center;align-items:center;">
                <img src="${joueur.photo || '../assets/avatar-default.png'}" class="avatar" alt="Avatar" style="width:64px;height:64px;border-radius:50%;object-fit:cover;border:2.5px solid #00fff9;background:#222;box-shadow:0 0 12px #00fff966;" />
              </div>
              <div class="player-name">${joueur.nom}</div>
            `;
          }
        } else {
          slot.innerHTML = `
            <div class="empty-avatar"></div>
            <div class="player-name">Place disponible</div>
          `;
          // Si l'utilisateur connecté est déjà dans la liste des joueurs, il ne peut pas cliquer sur une place vide
          const dejaDansSalon = userNom && Array.isArray(salon.joueurs) && salon.joueurs.some(j => j.nom === userNom);
          if (!dejaDansSalon) {
            slot.style.cursor = 'pointer';
            slot.onclick = function () {
              createJoinModal(async function (nom, photo) {
                // Mettre à jour la liste des joueurs côté backend
                if (!salon || !Array.isArray(salon.joueurs)) return;
                salon.joueurs[i] = { nom, photo };
                try {
                  await fetch('../backend/salons.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      nom: salon.nom,
                      code: salon.code,
                      maxJoueurs: salon.maxJoueurs,
                      longueurMot: salon.longueurMot,
                      joueurs: salon.joueurs
                    })
                  });
                } catch (e) { }
                await chargerSalonEtAfficher();
              });
            };
          } else {
            slot.style.cursor = 'not-allowed';
          }
        }
        playersList.appendChild(slot);
      }
    }
    chargerSalonEtAfficher();
    window.addEventListener('storage', function (e) {
      if (e.key === 'salon-supprime') {
        chargerSalonEtAfficher();
      }
    });

    // --- Bouton DÉMARRER ---
    const btnStart = document.getElementById('btn-start');
    function updateStartButton() {
      if (!salon || !Array.isArray(salon.joueurs)) return;
      // Démarrer si toutes les places sont prises
      btnStart.disabled = !(salon.joueurs.length === salon.maxJoueurs);
      if (!btnStart.disabled) btnStart.classList.add('active');
      else btnStart.classList.remove('active');
    }
    updateStartButton();

    btnStart.addEventListener('click', function () {
      if (isHote && salon && Array.isArray(salon.joueurs) && salon.joueurs.length >= minJoueurs) {
        // Logique de démarrage du jeu pour tous (à implémenter)
        alert('Le jeu commence !');
      }
    });

    // --- Bouton SUPPRIMER (pour l'hôte) ---

    // --- Bouton QUITTER ---
    document.getElementById('btn-quit').addEventListener('click', function () {
      window.location.href = 'creer-salon.html';
    });
  </script>
</body>
<script src="/Trouvix/js/session-nav.js"></script>

</html>