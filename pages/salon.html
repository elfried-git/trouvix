<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salon - Trouvix</title>
    <style>
        body {
            background: radial-gradient(ellipse at 50% 0%, #1a1d3a 60%, #10132a 100%);
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 420px;
            margin: 60px auto;
            background: rgba(24, 28, 58, 0.98);
            padding: 38px 20px 32px 20px;
            border-radius: 1.7rem;
            box-shadow: 0 0 48px #00fff9cc, 0 0 0 3px #00fff933, 0 0 80px 8px #ff00ff22;
            border: 1.5px solid #00fff9;
            position: relative;
            overflow: hidden;
            animation: fadeIn 1.1s cubic-bezier(.4, 0, .2, 1);
        }

        @media (max-width: 600px) {
            .container {
                max-width: 98vw;
                margin: 24px auto;
                padding: 18px 4vw 24px 4vw;
                border-radius: 1.1rem;
            }

            h1 {
                font-size: 1.25em;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: none;
            }
        }

        h1 {
            color: #00fff9;
            font-size: 2.1em;
            margin-bottom: 1.3em;
            text-align: center;
            font-weight: bold;
            letter-spacing: 0.04em;
            text-shadow: 0 0 16px #00fff9, 0 0 32px #00fff9;
        }

        .players {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 1.2em;
            margin-top: 2.2em;
        }

        .player-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5em;
        }

        .avatar {
            width: 74px;
            height: 74px;
            border-radius: 50%;
            border: 3px solid #00fff9;
            background: linear-gradient(135deg, #181c3a 60%, #00fff9 100%);
            object-fit: cover;
            box-shadow: 0 0 16px #00fff966, 0 0 32px #00fff933;
            transition: box-shadow 0.22s, border 0.22s;
        }

        .avatar.player {
            border: 3px solid #ffe600;
            background: linear-gradient(135deg, #181c3a 60%, #ffe600 100%);
            box-shadow: 0 0 24px #ffe60099, 0 0 48px #00fff966;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .avatar.player:hover {
            box-shadow: 0 0 32px #ffe600cc, 0 0 64px #00fff9cc;
            border: 3px solid #fff200;
        }

        .player-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2em;
        }

        .host {
            border: 3px solid #ff00ff;
            box-shadow: 0 0 24px #ff00ff99, 0 0 48px #00fff966;
        }

        .player-name {
            color: #00fff9;
            font-weight: 600;
            font-size: 1.08em;
            text-align: center;
            margin-top: 0.2em;
            text-shadow: 0 0 8px #00fff9cc;
        }

        .slot-status {
            color: #888;
            font-size: 0.98em;
            margin-top: 0.1em;
            text-align: center;
        }

        .photo-placeholder {
            width: 74px;
            height: 74px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #00fff9 0%, #ff00ff 100%);
            color: #181c3a;
            font-size: 1.18em;
            font-weight: bold;
            box-shadow: 0 0 16px #00fff966, 0 0 32px #ff00ff99;
            margin-bottom: 0.2em;
            border: 3px dashed #fff;
            text-shadow: 0 0 8px #fff, 0 0 16px #00fff9cc;
            letter-spacing: 0.04em;
            transition: box-shadow 0.22s;
        }

        .photo-placeholder:hover {
            box-shadow: 0 0 32px #ff00ffcc, 0 0 48px #00fff9cc;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="salon-message"
            style="text-align:center;font-size:1.18em;font-weight:bold;margin-bottom:1.1em;color:#00fff9;text-shadow:0 0 8px #00fff9cc;">
        </div>
        <h1>Salon</h1>
        <div id="salon-code"
            style="text-align:center;font-size:1.12em;font-weight:600;color:#ff00ff;margin-bottom:1.1em;text-shadow:0 0 8px #ff00ff99;">
        </div>
        <div id="host-info" style="text-align:center;margin-bottom:2em;"></div>
        <div class="players" id="players-list"></div>
        <div class="salon-btns" style="display:flex;justify-content:center;margin-top:2.5em;gap:0.8em;">
            <button class="btn-demarrer" id="btn-demarrer" style="display:none;">Jouons</button>
            <button class="btn-quitter" id="btn-quitter" style="background:linear-gradient(90deg,#ff0055 0%,#ff00ff 100%);color:#fff;font-weight:bold;font-size:1.13em;padding:0.7em 2.2em;border-radius:0.8em;border:none;box-shadow:0 0 16px #ff0055cc,0 0 32px #ff00ff99;cursor:pointer;">Quitter</button>
        </div>
    </div>
    </style>
    <style>
        .salon-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 2.5em;
        }

        .btn-retour,
        .btn-demarrer,
        .btn-quitter {
            background: #00fff9;
            border: none;
            color: #000;
            padding: 0.8em 1.6em;
            font-size: 1em;
            border-radius: 0.6rem;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 16px #00fff9cc, 0 0 32px #00fff933;
            transition: background 0.3s, box-shadow 0.3s;
        }

        .btn-retour:hover,
        .btn-demarrer:hover {
            background: #00e6e6;
            box-shadow: 0 0 24px #00e6e699, 0 0 48px #00e6e666;
        }

        .btn-demarrer {
            background: #ff00ff;
            color: #fff;
            box-shadow: 0 0 16px #ff00ffcc, 0 0 32px #ff00ff33;
        }

        .btn-demarrer:hover {
            background: #e600e6;
            box-shadow: 0 0 24px #e600e699, 0 0 48px #e600e666;
        }

        .btn-quitter {
            background: linear-gradient(90deg,#ff0055 0%,#ff00ff 100%);
            color: #fff;
            box-shadow: 0 0 16px #ff0055cc, 0 0 32px #ff00ff99;
        }
    </style>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const salonCode = urlParams.get('code');
        let currentUserNom = null;
        let hasShownKickPopin = false;

        async function fetchSalonFromBackend() {
            try {
                const res = await fetch('../backend/salons.php');
                if (!res.ok) throw new Error('Erreur serveur');
                const salons = await res.json();
                return salons.find(s => s.code === salonCode);
            } catch (e) {
                return null;
            }
        }

        async function renderSalon() {
            const salon = await fetchSalonFromBackend();
            let userNom = null;
            try {
                const userInfo = await fetch('../backend/get_user_info.php');
                if (userInfo.ok) {
                    const data = await userInfo.json();
                    if (data && data.nom) userNom = data.nom;
                }
            } catch (e) { }
            if (userNom) currentUserNom = userNom;
            if (!salon) {
                document.getElementById('salon-message').textContent = 'Salon introuvable.';
                document.getElementById('players-list').innerHTML = '';
                document.getElementById('host-info').innerHTML = '';
                document.getElementById('salon-code').textContent = '';
                return;
            }
            if (userNom && !salon.joueurs.some(j => j && j.nom === userNom)) {
                // Player was kicked out: show popin and prevent multiple popins
                if (!hasShownKickPopin) {
                    hasShownKickPopin = true;
                                // Popin stylée pour l'expulsion
                                let popin = document.createElement('div');
                                popin.innerHTML = `
                                    <div id="popin-kick-bg" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,20,40,0.65);z-index:99999;display:flex;align-items:center;justify-content:center;">
                                        <div id="popin-kick" style="background:#181c3a;padding:2.2em 2em 1.5em 2em;border-radius:1.2em;box-shadow:0 0 32px #00fff966,0 0 0 2px #00fff933;min-width:260px;text-align:center;">
                                            <div style="color:#ff0055;font-size:1.18em;font-weight:bold;margin-bottom:1.2em;">Vous avez été retiré du salon.</div>
                                            <button id="popin-kick-ok" style="background:linear-gradient(90deg,#00fff9 60%,#ff00ff 100%);color:#181c3a;border:none;border-radius:0.7em;padding:0.7em 2.2em;font-size:1.13em;font-weight:bold;cursor:pointer;box-shadow:0 0 16px #00fff966;">OK</button>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(popin);
                                document.getElementById('popin-kick-ok').onclick = function() {
                                    popin.remove();
                                    window.location.href = 'espace-membre.php';
                                };
                }
                                return;
            }
            hasShownKickPopin = false;
            document.getElementById('salon-code').textContent = `Code du salon : ${salon.code}`;
            let nomHoteSession = null;
            try {
                const userInfo = await fetch('../backend/get_user_info.php');
                if (userInfo.ok) {
                    const data = await userInfo.json();
                    if (data && data.nom) nomHoteSession = data.nom;
                }
            } catch (e) { }
            const hote = salon.joueurs[0];
            let nomAffiche = hote && hote.nom ? hote.nom : 'Hôte';
            if (nomHoteSession && hote && hote.nom && nomHoteSession === hote.nom) {
                nomAffiche = nomHoteSession;
            }
            let hostImgAttrs = `src="${hote && hote.photo ? hote.photo : '../assets/avatar-default.png'}" class="avatar host" alt="Avatar Hôte"`;
            if (nomHoteSession && hote && hote.nom && nomHoteSession === hote.nom) {
                hostImgAttrs += ' style="cursor:pointer;box-shadow:0 0 32px #ffe600cc,0 0 64px #00fff9cc;transition:box-shadow 0.18s;" id="host-avatar-clickable"';
            }
            document.getElementById('host-info').innerHTML = `
            <img ${hostImgAttrs}>
            <div class="player-name">${nomAffiche} <span style="font-size:0.8em;color:#ff00ff;">(Hôte)</span></div>
        `;
            if (nomHoteSession && hote && hote.nom && nomHoteSession === hote.nom) {
                setTimeout(() => {
                    const img = document.getElementById('host-avatar-clickable');
                    if (img) img.onclick = () => { renderSalon(); };
                }, 50);
                // Affiche le bouton de démarrage uniquement pour l'hôte
                const btnDemarrer = document.getElementById('btn-demarrer');
                if (btnDemarrer) {
                    btnDemarrer.style.display = 'inline-block';
                    btnDemarrer.onclick = function () {
                        try {
                            if (salon && salon.code) {
                                localStorage.setItem('codeSalon', salon.code);
                                sessionStorage.setItem('codeSalon', salon.code);
                                window.location.href = 'jeux-encours.html?code=' + encodeURIComponent(salon.code);
                            } else {
                                window.location.href = 'jeux-encours.html';
                            }
                        } catch (e) {
                            window.location.href = 'jeux-encours.html';
                        }
                    };
                }

                // Si l'utilisateur est l'hôte, écouter les événements SSE pour mises à jour du salon
                (function listenSalonEvents() {
                    if (!window.EventSource || !salon || !salon.code) return;
                    // évite d'ouvrir plusieurs connexions SSE pour le même salon
                    if (window.__salonSseActive && window.__salonSseActive === salon.code) return;
                    window.__salonSseActive = salon.code;
                    let evt = new EventSource(`../backend/salon_events.php?code=${encodeURIComponent(salon.code)}`);
                    evt.onmessage = function (e) {
                        try {
                            const data = JSON.parse(e.data);
                            if (data && data.event) {
                                // Rafraîchir la vue du salon (recharge joueurs, host info...)
                                renderSalon();
                                if (data.event === 'salon_supprime') {
                                    // Salon détruit : prévenir et rediriger
                                    let oldPopin = document.getElementById('salon-detruit-popin');
                                    if (oldPopin) oldPopin.remove();
                                    const popin = document.createElement('div');
                                    popin.id = 'salon-detruit-popin';
                                    popin.innerHTML = `
                                        <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,16,40,0.92);z-index:3100;display:flex;align-items:center;justify-content:center;">
                                            <div style="background:#181c3a;padding:2.2em 2.5em 2em 2.5em;border-radius:1.2em;box-shadow:0 0 32px #00fff966,0 0 0 2px #00fff933,0 0 80px 8px #ff00ff22;text-align:center;max-width:90vw;border:1.5px solid #00fff9;">
                                                <div style='font-size:1.18em;color:#00fff9;font-weight:bold;margin-bottom:1.2em;'>Salon détruit</div>
                                                <div style='color:#fff;margin-bottom:1.2em;'>Le salon a été détruit. Vous allez être redirigé.</div>
                                                <button id="btn-salon-detruit-ok" style="background:linear-gradient(90deg,#00fff9 0%,#ff00ff 100%);color:#181c3a;font-weight:bold;font-size:1.13em;padding:0.7em 2.2em;border-radius:0.8em;border:none;box-shadow:0 0 16px #00fff9cc,0 0 32px #ff00ff99;cursor:pointer;">OK</button>
                                            </div>
                                        </div>
                                    `;
                                    document.body.appendChild(popin);
                                    document.getElementById('btn-salon-detruit-ok').onclick = function () {
                                        window.location.href = 'espace-membre.php';
                                    };
                                }
                            }
                        } catch (err) {
                            // données non JSON ou autre -> forcer refresh
                            renderSalon();
                        }
                        // close current connection; salon_events.php returns once per call
                        try { evt.close(); } catch (e) {}
                        window.__salonSseActive = null;
                        // reconnect after small delay
                        setTimeout(listenSalonEvents, 800);
                    };
                    evt.onerror = function () {
                        try { evt.close(); } catch (e) {}
                        window.__salonSseActive = null;
                        setTimeout(listenSalonEvents, 1200);
                    };
                })();
            }
            const playersList = document.getElementById('players-list');
            playersList.innerHTML = '';
            const totalSlots = salon.maxJoueurs;
            for (let i = 1; i < totalSlots; i++) {
                const joueur = salon.joueurs[i];
                if (joueur && joueur.nom && joueur.photo) {
                    let retirerBtn = '';
                    if (nomHoteSession && hote && hote.nom && nomHoteSession === hote.nom) {
                        retirerBtn = `<button class="btn-retirer-joueur" data-nom="${joueur.nom}" style="margin-top:0.5em;background:#ff0055;color:#fff;border:none;border-radius:0.5em;padding:0.3em 0.9em;font-weight:bold;cursor:pointer;box-shadow:0 0 8px #ff0055cc;">Retirer</button>`;
                    }
                    playersList.innerHTML += `
                    <div class="player-block">
                        <img src="${joueur.photo}" class="avatar player" alt="Avatar joueur">
                        <div class="player-name">${joueur.nom}</div>
                        ${retirerBtn}
                    </div>
                `;
                } else {
                    playersList.innerHTML += `
                    <div class="player-slot">
                        <div class="photo-placeholder">Photo</div>
                        <div class="slot-status">Disponible</div>
                    </div>
                `;
                }
            }
            const joueursConnectes = salon.joueurs.filter(j => j && j.nom && j.photo).length;
            const salonMsg = document.getElementById('salon-message');
            if (joueursConnectes < totalSlots) {
                salonMsg.textContent = 'En attente des joueurs...';
                salonMsg.style.color = '#00fff9';
            } else {
                salonMsg.textContent = 'Place au jeu !';
                salonMsg.style.color = '#ff00ff';
            }
        }
        renderSalon();
        setTimeout(() => {
            document.querySelectorAll('.btn-retirer-joueur').forEach(btn => {
                btn.onclick = async function () {
                    const nomARetirer = this.getAttribute('data-nom');
                    const clickedBtn = this;
                                        // Popin personnalisée
                                        let popin = document.createElement('div');
                                        popin.innerHTML = `
                                            <div id="popin-confirm-bg" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,20,40,0.65);z-index:99999;display:flex;align-items:center;justify-content:center;">
                                                <div id="popin-confirm" style="background:#181c3a;padding:2.2em 2em 1.5em 2em;border-radius:1.2em;box-shadow:0 0 32px #00fff966,0 0 0 2px #00fff933;min-width:260px;text-align:center;">
                                                    <div style="color:#0ff1ce;font-size:1.18em;font-weight:bold;margin-bottom:1.2em;">Retirer <span style='color:#ff00ff'>${nomARetirer}</span> du salon ?</div>
                                                    <button id="popin-ok" style="background:linear-gradient(90deg,#00fff9 60%,#ff00ff 100%);color:#181c3a;border:none;border-radius:0.7em;padding:0.7em 2.2em;font-size:1.13em;font-weight:bold;cursor:pointer;box-shadow:0 0 16px #00fff966;margin-right:1.2em;">Oui</button>
                                                    <button id="popin-cancel" style="background:#222a44;color:#fff;border:none;border-radius:0.7em;padding:0.7em 2.2em;font-size:1.13em;font-weight:bold;cursor:pointer;box-shadow:0 0 8px #222a44;">Annuler</button>
                                                </div>
                                            </div>
                                        `;
                                        document.body.appendChild(popin);
                                        document.getElementById('popin-cancel').onclick = function() {
                                            popin.remove();
                                        };
                                        document.getElementById('popin-ok').onclick = async function() {
                                            popin.remove();
                                            // Optimistic UI: mark the player as removed immediately in the host UI
                                            try {
                                                const playerBlock = clickedBtn.closest('.player-block');
                                                if (playerBlock) {
                                                    playerBlock.style.opacity = '0.45';
                                                    playerBlock.style.transition = 'opacity 0.25s';
                                                    const nameEl = playerBlock.querySelector('.player-name');
                                                    if (nameEl && !nameEl.dataset._removed) {
                                                        nameEl.dataset._removed = '1';
                                                        nameEl._oldText = nameEl.textContent;
                                                        nameEl.textContent = nameEl._oldText + ' (Retiré...)';
                                                    }
                                                }
                                            } catch (e) {}
                                            try {
                                                const res = await fetch('../backend/kick_player.php', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ code: salonCode, nom: nomARetirer }),
                                                    credentials: 'same-origin'
                                                });
                                                let result = null;
                                                try {
                                                    result = await res.json();
                                                } catch (e) {
                                                    result = null;
                                                }
                                                if (res.ok && result && result.success) {
                                                    // renderSalon will also be triggered by SSE; ensure UI is consistent
                                                    renderSalon();
                                                } else {
                                                    // revert optimistic change
                                                    try {
                                                        const playerBlock = clickedBtn.closest('.player-block');
                                                        if (playerBlock) {
                                                            playerBlock.style.opacity = '';
                                                            const nameEl = playerBlock.querySelector('.player-name');
                                                            if (nameEl && nameEl.dataset._removed) {
                                                                nameEl.textContent = nameEl._oldText || nameEl.textContent.replace(' (Retiré...)','');
                                                                delete nameEl.dataset._removed;
                                                            }
                                                        }
                                                    } catch (e) {}
                                                    const errMsg = (result && result.error) ? result.error : (res.statusText || 'Erreur lors du retrait');
                                                    alert(errMsg);
                                                }
                                            } catch (e) {
                                                // revert optimistic change
                                                try {
                                                    const playerBlock = clickedBtn.closest('.player-block');
                                                    if (playerBlock) {
                                                        playerBlock.style.opacity = '';
                                                        const nameEl = playerBlock.querySelector('.player-name');
                                                        if (nameEl && nameEl.dataset._removed) {
                                                            nameEl.textContent = nameEl._oldText || nameEl.textContent.replace(' (Retiré...)','');
                                                            delete nameEl.dataset._removed;
                                                        }
                                                    }
                                                } catch (e) {}
                                                alert('Erreur réseau lors du retrait');
                                            }
                                        };
                                        return;
                };
            });
        }, 200);
        // Realtime: prefer WebSocket; fallback to SSE if WS not available.
        (function startRealtime() {
            const wsHost = (window.location.hostname || '127.0.0.1');
            const wsPort = 3001;
            const wsUrl = `ws://${wsHost}:${wsPort}`;

            let ws = null;
            let sse = null;

            function handleEventData(data) {
                try {
                    if (data && data.event) {
                        renderSalon();
                        if (data.event === 'salon_supprime') {
                            let oldPopin = document.getElementById('salon-detruit-popin');
                            if (oldPopin) oldPopin.remove();
                            const popin = document.createElement('div');
                            popin.id = 'salon-detruit-popin';
                            popin.innerHTML = `
                                <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,16,40,0.92);z-index:3100;display:flex;align-items:center;justify-content:center;">
                                    <div style="background:#181c3a;padding:2.2em 2.5em 2em 2.5em;border-radius:1.2em;box-shadow:0 0 32px #00fff966,0 0 0 2px #00fff933,0 0 80px 8px #ff00ff22;text-align:center;max-width:90vw;border:1.5px solid #00fff9;">
                                        <div style='font-size:1.18em;color:#00fff9;font-weight:bold;margin-bottom:1.2em;'>Salon détruit</div>
                                        <div style='color:#fff;margin-bottom:1.2em;'>Le salon a été détruit. Vous allez être redirigé.</div>
                                        <button id="btn-salon-detruit-ok" style="background:linear-gradient(90deg,#00fff9 0%,#ff00ff 100%);color:#181c3a;font-weight:bold;font-size:1.13em;padding:0.7em 2.2em;border-radius:0.8em;border:none;box-shadow:0 0 16px #00fff9cc,0 0 32px #ff00ff99;cursor:pointer;">OK</button>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(popin);
                            document.getElementById('btn-salon-detruit-ok').onclick = function () {
                                window.location.href = 'espace-membre.php';
                            };
                        }
                    }
                } catch (err) {
                    renderSalon();
                }
            }

            function startSSE() {
                if (!window.EventSource || !salonCode) return;
                if (sse) try { sse.close(); } catch (e) {}
                sse = new EventSource(`../backend/salon_events.php?code=${encodeURIComponent(salonCode)}`);
                sse.onmessage = function (e) {
                    try {
                        const data = JSON.parse(e.data);
                        handleEventData(data);
                    } catch (err) {
                        renderSalon();
                    }
                    try { sse.close(); } catch (e) {}
                    setTimeout(startSSE, 800);
                };
                sse.onerror = function () {
                    try { sse.close(); } catch (e) {}
                    setTimeout(startSSE, 1200);
                };
            }

            function startWS() {
                try {
                    ws = new WebSocket(wsUrl);
                } catch (e) {
                    // fallback to SSE
                    startSSE();
                    return;
                }
                let connected = false;
                const reconnect = () => {
                    try { if (ws) ws.close(); } catch (e) {}
                    setTimeout(startWS, 1200);
                };
                ws.onopen = function () {
                    connected = true;
                };
                ws.onmessage = function (msg) {
                    try {
                        const data = JSON.parse(msg.data);
                        handleEventData(data);
                    } catch (err) {
                        renderSalon();
                    }
                };
                ws.onclose = function () {
                    connected = false;
                    // WS not available -> fallback to SSE
                    startSSE();
                };
                ws.onerror = function () {
                    try { ws.close(); } catch (e) {}
                };
            }

            // Start WS first, fallback to SSE automatically
            startWS();
        })();
        (function() {
            const btnQuit = document.getElementById('btn-quitter');
            if (btnQuit) {
                btnQuit.onclick = async function () {
                    try {
                        await fetch('../backend/leave_salon.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: salonCode })
                        });
                    } catch (e) {
                        // ignore network errors, we'll redirect anyway
                    }
                    window.location.href = 'espace-membre.php';
                };
            }
        })();
    </script>
</body>

</html>