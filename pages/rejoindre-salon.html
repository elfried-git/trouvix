<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rejoindre un Salon - DeviChal</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body {
      background: #10132a;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .join-salon-container {
      max-width: 400px;
      margin: 4rem auto 0 auto;
      background: #181c3a;
      border-radius: 1.5rem;
      box-shadow: 0 0 32px #00fff966, 0 0 0 2px #00fff933;
      padding: 2.2rem 1.5rem 2.2rem 1.5rem;
      text-align: center;
      position: relative;
    }
    .join-title {
      font-size: 1.7rem;
      color: #00fff9;
      letter-spacing: 0.04em;
      text-shadow: 0 0 8px #00fff9, 0 0 24px #00fff9;
      margin-bottom: 1.2em;
    }
    .form-group {
      margin-bottom: 1.3em;
      text-align: left;
      position: relative;
    }
    .form-label {
      color: #fff;
      font-weight: 500;
      margin-bottom: 0.3em;
      display: block;
    }
    .form-input {
      width: 100%;
      background: #181c3a;
      color: #00fff9;
      border: 2px solid #00fff9;
      border-radius: 0.5em;
      padding: 0.6em 1em;
      font-size: 1.1em;
      outline: none;
      margin-top: 0.2em;
      transition: border 0.2s;
      box-sizing: border-box;
    }
    .form-input:focus {
      border: 2px solid #ff00ff;
      box-shadow: 0 0 8px #ff00ff66;
    }
    .form-error {
      color: #ff00ff;
      font-size: 0.98em;
      margin-top: 0.2em;
      margin-bottom: 0.2em;
      opacity: 0.95;
      font-weight: bold;
    }
    .avatar-select-row {
      display: flex;
      gap: 0.7em;
      justify-content: center;
      margin-top: 0.5em;
      margin-bottom: 0.2em;
    }
    .avatar-choice {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2.5px solid #00fff9;
      background: #222;
      box-shadow: 0 0 0 4px #00fff966;
      cursor: pointer;
      object-fit: cover;
      transition: border 0.2s, box-shadow 0.2s;
      opacity: 0.8;
    }
    .avatar-choice.selected {
      border: 2.5px solid #ff00ff;
      box-shadow: 0 0 0 7px #ff00ff66;
      opacity: 1;
    }
    .join-btn {
      width: 100%;
      background: linear-gradient(90deg, #00fff9 60%, #ff00ff 100%);
      color: #181c3a;
      border: none;
      border-radius: 0.7em;
      font-size: 1.2em;
      font-weight: bold;
      padding: 0.8em 0;
      margin-top: 1.2em;
      cursor: pointer;
      box-shadow: 0 0 16px #00fff966;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.2s;
      text-shadow: 0 0 8px #fff;
      opacity: 0.7;
    }
    .join-btn.active {
      opacity: 1;
      transform: scale(1.04);
      box-shadow: 0 0 24px #ff00ff99;
      background: linear-gradient(90deg, #ff00ff 0%, #00fff9 100%);
    }
    .join-btn:disabled {
      background: #222;
      color: #888;
      box-shadow: none;
      cursor: not-allowed;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div class="join-salon-container">
    <div class="join-title">Rejoindre un Salon</div>
    <form id="join-form" autocomplete="off">
      <div class="form-group">
        <label class="form-label" for="pin">Code PIN du Salon</label>
        <input class="form-input" id="pin" maxlength="6" minlength="6" required pattern="[A-Za-z0-9]{6}" type="text" placeholder="Ex: 1A2B3C" style="text-transform:uppercase;letter-spacing:0.1em;">
        <div class="form-error" id="pin-error"></div>
      </div>
      <div class="form-group">
        <label class="form-label" for="player-name">Nom du Joueur</label>
        <input class="form-input" id="player-name" maxlength="15" required type="text" placeholder="Joueur Cool123">
        <div class="form-error" id="name-error"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Photo</label>
        <div style="display:flex;justify-content:center;align-items:center;">
          <label id="avatar-upload-label" style="width:64px;height:64px;border-radius:50%;border:3px solid #00fff9;box-shadow:0 0 0 6px #00fff966,0 0 24px 8px #00fff966;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative;animation:pulse-cyan 1.5s infinite alternate;background:#222;">
            <input type="file" id="avatar-upload" accept="image/*" style="display:none;">
            <span id="avatar-placeholder" style="color:#00fff9;font-size:2em;opacity:0.7;">+</span>
            <img id="avatar-preview" src="" alt="AperÃ§u photo" style="display:none;width:100%;height:100%;object-fit:cover;">
        <header>
          <div class="header-row">
            <div class="logo" tabindex="0" aria-label="Accueil Trouvix">
              <span class="logo-text">Trouvix</span>
            </div>
            <nav id="main-nav" class="main-nav" aria-label="Navigation principale">
              <ul>
                <li><a href="../index.html">Accueil</a></li>
                <li><a href="../index.html#contact">Contact</a></li>
                <li><a href="jeux-quiz.html">Jeux / Quiz</a></li>
                <li><a href="../page-apprentissage-langues/index.html">Apprentissage des Langues</a></li>
                <li><a href="tv-replay.html">TV / Replay</a></li>
                <li id="menu-user-icon" style="display:none">
                  <a href="espace-membre.php" title="Espace membre" style="display:flex;align-items:center;gap:0.4em;">
                    <span style="font-size:1.5em;">ðŸ‘¤</span>
                    <span id="menu-user-nom" style="font-size:1em;"></span>
                  </a>
                </li>
                <li id="menu-login-link"><a href="../auth/login.html">Connexion</a></li>
                <li id="menu-logout-link" style="display:none"><form action="logout.php" method="post" style="display:inline;"><button type="submit" style="background:none;border:none;color:#0ff1ce;font-size:1em;cursor:pointer;">DÃ©connexion</button></form></li>
              </ul>
            </nav>
          </div>
        </header>
        <script src="../js/session-nav.js"></script>
    // Upload photo avatar (unique)
    let avatarOk = false;
    let selectedAvatar = '';
    const avatarInput = document.getElementById('avatar-upload');
    const avatarPreview = document.getElementById('avatar-preview');
    const avatarPlaceholder = document.getElementById('avatar-placeholder');
    const avatarLabel = document.getElementById('avatar-upload-label');
    avatarInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          avatarPreview.src = ev.target.result;
          avatarPreview.style.display = 'block';
          avatarPlaceholder.style.display = 'none';
          avatarLabel.classList.add('has-photo');
          avatarOk = true;
          selectedAvatar = ev.target.result;
          validateForm();
        };
        reader.readAsDataURL(file);
      } else {
        avatarPreview.src = '';
        avatarPreview.style.display = 'none';
        avatarPlaceholder.style.display = 'block';
        avatarLabel.classList.remove('has-photo');
        avatarOk = false;
        selectedAvatar = '';
        validateForm();
      }
    });
    // Suggestion nom joueur
    const playerNameInput = document.getElementById('player-name');
    if (!playerNameInput.value) {
      playerNameInput.placeholder = 'Joueur Cool' + Math.floor(Math.random()*1000);
    }
    // Validation
    const pinInput = document.getElementById('pin');
    const btn = document.getElementById('join-btn');
    function validateForm() {
      let valid = true;
      // PIN
      const pin = pinInput.value.trim().toUpperCase();
      if (pin.length !== 6 || !/^[A-Za-z0-9]{6}$/.test(pin)) {
        document.getElementById('pin-error').textContent = 'Code PIN invalide';
        valid = false;
      } else {
        document.getElementById('pin-error').textContent = '';
      }
      // Nom
      const name = playerNameInput.value.trim();
      if (!name || name.length > 15) {
        document.getElementById('name-error').textContent = 'Nom requis (max 15)';
        valid = false;
      } else {
        document.getElementById('name-error').textContent = '';
      }
      // Avatar photo obligatoire
      if (!avatarOk) {
        document.getElementById('avatar-error').textContent = 'Ajoutez une photo';
        valid = false;
      } else {
        document.getElementById('avatar-error').textContent = '';
      }
      btn.disabled = !valid;
      btn.classList.toggle('active', valid);
      return valid;
    }
    pinInput.addEventListener('input', function() {
      this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0,6);
      validateForm();
    });
    playerNameInput.addEventListener('input', validateForm);
    // Form submit
    document.getElementById('join-form').addEventListener('submit', function(e) {
      e.preventDefault();
      if (!validateForm()) return;
      // VÃ©rifier existence salon et unicitÃ© nom
      let salons = [];
      try {
        salons = JSON.parse(localStorage.getItem('salons') || '[]');
      } catch(e) { salons = []; }
      const pin = pinInput.value.trim().toUpperCase();
      const salon = salons.find(s => s.code === pin);
      if (!salon) {
        document.getElementById('form-global-error').textContent = 'Aucun salon trouvÃ© avec ce code PIN.';
        return;
      }
      const name = playerNameInput.value.trim();
      if (salon.joueurs && salon.joueurs.some(j => j.nom.toLowerCase() === name.toLowerCase())) {
        document.getElementById('form-global-error').textContent = 'Ce nom est dÃ©jÃ  pris dans ce salon.';
        return;
      }
      // Ajouter le joueur
      if (!salon.joueurs) salon.joueurs = [];
      salon.joueurs.push({ nom: name, photo: selectedAvatar });
      // Mettre Ã  jour le salon dans localStorage
      const idx = salons.findIndex(s => s.code === pin);
      salons[idx] = salon;
      localStorage.setItem('salons', JSON.stringify(salons));
      // Rediriger vers la page lobby ou jeu
      window.location.href = `lobby.html?pin=${pin}&player=${encodeURIComponent(name)}`;
    });
  </script>
</body>
<script src="../js/session-nav.js"></script>
</html>
